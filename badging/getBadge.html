<script>
  function setCookie(key, value) {
    var expires = new Date();
    // Log back in in a week.
    expires.setTime(expires.getTime() + 7 * 24 * 60 * 60 * 1000);
    document.cookie = key + '=' + value + ';expires=' + expires.toUTCString();
  }

  function getCookie(key) {
    var keyValue = document.cookie.match('(^|;) ?' + key + '=([^;]*)(;|$)');
    return keyValue ? keyValue[2] : null;
  }

  let badge_access_token = '';
  let badge_refresh_token = '';

  function getBadgrId(){

      $.ajax({
        type: 'GET',
        url: 'https://api.badgr.io/v2/users/self',
        // dataType: 'json',
        // contentType: 'application/json',
        async: true,
        data: '{}',
        beforeSend: function(xhr) {
          // console.log('sending header');
          xhr.setRequestHeader('Authorization', 'Bearer ' + getCookie('hx_badge_access_token'));
        },
        success: function(data) {
          console.log('data received');
          setCookie('hx_badge_userId', data.result[0].entityId);
          console.log('access:', getCookie('hx_badge_userId'));
        },
        error: function(data) {
          console.log('error');
          console.log(data);
        }
      });
  }

  function getBadgrCreds() {
    console.log('getting Badgr credentials');
    $('#got_creds').empty();
    $.ajax({
      type: 'POST',
      url: 'https://api.badgr.io/o/token',
      // dataType: 'json',
      // contentType: 'application/json',
      async: true,
      data:
        'username=' +
        $('#badge_email').val() +
        '&password=' +
        $('#badge_password').val(),
      success: function(data) {
        console.log('data received');
        hx_badge_access_token = data.access_token;
        hx_badge_refresh_token = data.refresh_token;
        console.log('access:', badge_access_token);
        console.log('refresh:', badge_refresh_token);
        $('#got_creds').append(
          '<span class="fa fa-check" style="color:green;"></span> Logged into badging.'
        );
        getBadgrId();
      },
      error: function(data) {
        console.log('error');
        console.log(data);
        $('#got_creds').append(
          '<span class="fa fa-times" style="color:#c00;"></span> Error logging into badging: ' +
            data.responseJSON.error_description
        );
      }
    });
  }

  $(document).ready(function() {
    // Auto-fill form with edX e-mail, but wait for analytics object.
    var waitForAnalytics = setInterval(function() {
      if (analytics.user()) {
        clearInterval(waitForAnalytics);
        $('#badge_email').val(analytics.user().properties().email);
      }
    }, 250);

    // Don't submit the form when someone hits "enter".
    $('form').keypress(function(e) {
      // Enter key is 13.
      if (e.which == 13) {
        return false;
      }
    });
  });
</script>

<p>
  Please enter the e-mail address and password that you use for Badgr.io, so
  that we can assign you badges. HarvardX will not store this information.
</p>

<form onsubmit="return false">
  <input type="email" id="badge_email" /><label for="badge_email"> E-mail</label
  ><br />
  <input type="password" id="badge_password" /><label for="badge_password">
    Password</label
  ><br />
  <input
    type="submit"
    value="Log in"
    id="badge_submit"
    onclick="getBadgrCreds();"
  /><span id="got_creds"></span>
</form>
